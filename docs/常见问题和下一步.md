# DSP éŸ³é¢‘åˆ†æ - å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

## âš ï¸ ä¸‰ä¸ªå¸¸è§å‘ï¼ˆå¿…è¯»ï¼‰

### å‘ 1: PowerShell ä¸­ conda activate å¤±è´¥

**é—®é¢˜**: åœ¨ PowerShell ä¸­è¿è¡Œ `conda activate dsp` æ—¶æç¤ºå‘½ä»¤æ‰¾ä¸åˆ°æˆ–æ— æ•ˆã€‚

**åŸå› **: Conda éœ€è¦åœ¨ PowerShell ä¸­åˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨ `activate` å‘½ä»¤ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```powershell
# æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–
conda init powershell

# é‡å¯ PowerShell
# ç„¶åå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨
conda activate dsp
```

**éªŒè¯**:
```powershell
# æ¿€æ´»åï¼Œå‘½ä»¤æç¤ºç¬¦å‰åº”è¯¥æ˜¾ç¤º (dsp)
(dsp) PS F:\TOMATIS>
```

---

### å‘ 2: éŸ³é¢‘è¯»å…¥çš„"æ»¡å¹…"å®šä¹‰ï¼ˆdBFS çš„ 0 ç‚¹ï¼‰

**é—®é¢˜**: è®¡ç®— dBFS æ—¶éœ€è¦ç»Ÿä¸€æ»¡å¹…å®šä¹‰ï¼Œå¦åˆ™ç»“æœæ²¡æœ‰æ„ä¹‰ã€‚

**è§„èŒƒåšæ³•**:

1. **ä½¿ç”¨ float32 è¯»å–éŸ³é¢‘**ï¼ŒPCM ä¼šè‡ªåŠ¨å½’ä¸€åŒ–åˆ° `[-1.0, 1.0]`ï¼š
   ```python
   x, sr = sf.read("audio.flac", dtype="float32")
   ```

2. **æ»¡å¹…å®šä¹‰ä¸º 1.0**ï¼ˆå³ full-scale = 1ï¼‰ï¼š
   ```python
   # è®¡ç®— RMS dBFS
   rms = np.sqrt(np.mean(x**2))
   dbfs = 20 * np.log10(rms)  # ç›¸å¯¹äºæ»¡å¹… 1.0
   ```

3. **ä¸è¦æ··ç”¨ä¸åŒçš„å½’ä¸€åŒ–æ–¹å¼**ï¼š
   - âœ“ æ­£ç¡®: `dtype="float32"` â†’ è‡ªåŠ¨å½’ä¸€åŒ–åˆ° [-1, 1]
   - âœ— é”™è¯¯: è¯»å–åå†æ‰‹åŠ¨é™¤ä»¥ 32768ï¼ˆä¼šå¯¼è‡´ dBFS åç§»ï¼‰

**ç¤ºä¾‹**:
```python
import soundfile as sf
import numpy as np

# è¯»å–ï¼ˆè‡ªåŠ¨å½’ä¸€åŒ–ï¼‰
x, sr = sf.read("input.flac", dtype="float32")

# è®¡ç®— RMS dBFS
EPS = 1e-12
rms = np.sqrt(np.mean(x**2) + EPS)
dbfs = 20 * np.log10(rms + EPS)

print(f"RMS dBFS: {dbfs:.2f} dB")
```

---

### å‘ 3: linspace çš„ endpoint å‚æ•°

**é—®é¢˜**: ç”Ÿæˆå‘¨æœŸä¿¡å·æ—¶ï¼Œ`linspace` é»˜è®¤ `endpoint=True` ä¼šå¯¼è‡´æœ€åä¸€ä¸ªç‚¹é‡å¤å‘¨æœŸè¾¹ç•Œã€‚

**å½±å“**: åš FFT/STFT æ—¶ä¼šå¼•å…¥è½»å¾®çš„é¢‘è°±æ³„æ¼ï¼ˆè™½ç„¶ä¸æ˜¯å¤§é—®é¢˜ï¼Œä½†ä¸è§„èŒƒï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```python
# âœ— é”™è¯¯ï¼ˆä¼šé‡å¤è¾¹ç•Œç‚¹ï¼‰
t = np.linspace(0, duration, int(sr * duration))

# âœ“ æ­£ç¡®
t = np.linspace(0, duration, int(sr * duration), endpoint=False)
```

**ç¤ºä¾‹**:
```python
import numpy as np

sr = 48000
duration = 1.0

# æ­£ç¡®çš„åšæ³•
t = np.linspace(0, duration, int(sr * duration), endpoint=False)
signal = np.sin(2 * np.pi * 440 * t)

# éªŒè¯ï¼šæœ€åä¸€ä¸ªç‚¹ä¸åº”è¯¥ç­‰äºç¬¬ä¸€ä¸ªç‚¹
print(f"ç¬¬ä¸€ä¸ªç‚¹: {signal[0]:.6f}")
print(f"æœ€åä¸€ä¸ªç‚¹: {signal[-1]:.6f}")
print(f"æ˜¯å¦ç›¸ç­‰: {np.isclose(signal[0], signal[-1])}")  # åº”è¯¥æ˜¯ False
```

---

## ğŸ¯ ä½ ç°åœ¨åº”è¯¥åšçš„ä¸‹ä¸€æ­¥

### å½“å‰ç›®æ ‡

ä½ çš„é¡¹ç›®ç›®æ ‡**ä¸æ˜¯**"èƒ½ç®— STFT"ï¼Œè€Œæ˜¯ï¼š

1. âœ… æŠŠ 3 ä»½éŸ³é¢‘ç»Ÿä¸€åˆ°åŒé‡‡æ ·ç‡/å£°é“
2. âœ… å¯¹é½ input / outputï¼ˆTomatis_D è¦å…ˆå¤„ç†å‰ 16 ç§’é”™æ®µï¼‰
3. âœ… é€å¸§è®¡ç®—çŸ­æ—¶ RMS â†’ dBFS æ›²çº¿
4. âœ… ç”¨ dBFS æ›²çº¿ + è¾“å‡ºå˜åŒ–æ¨æ–­ gate çš„ç­‰æ•ˆé˜ˆå€¼

### å·¥ä½œæµç¨‹

```
åŸå§‹éŸ³é¢‘æ–‡ä»¶
    â†“
ç»Ÿä¸€é‡‡æ ·ç‡ + è½¬å•å£°é“
    â†“
è£å‰ªé”™æ®µï¼ˆTomatis å‰ 16 ç§’ï¼‰
    â†“
äº’ç›¸å…³å¯¹é½
    â†“
RMS å½’ä¸€åŒ–
    â†“
å¸§çº§ dBFS è®¡ç®—
    â†“
å¯¼å‡º CSV + å¯è§†åŒ–
    â†“
åˆ†æ gate é˜ˆå€¼
```

---

## ğŸ“ æœ€å°å¯è·‘è„šæœ¬

å·²åˆ›å»º [analyze_dbfs.py](file:///F:/TOMATIS/analyze_dbfs.py)ï¼ŒåŒ…å«å®Œæ•´çš„åˆ†ææµç¨‹ã€‚

### ä½¿ç”¨æ–¹æ³•

1. **å‡†å¤‡éŸ³é¢‘æ–‡ä»¶**ï¼ˆæ”¾åœ¨ `F:\TOMATIS` ç›®å½•ï¼‰ï¼š
   - `D_MNF.flac` - è¾“å…¥éŸ³é¢‘
   - `Tomatis_D.flac` - Tomatis è¾“å‡º
   - `matlab_D_15db_1000Hz_12db.flac` - Matlab è¾“å‡º

2. **è¿è¡Œè„šæœ¬**ï¼š
   ```powershell
   conda activate dsp
   python analyze_dbfs.py
   ```

3. **æŸ¥çœ‹ç»“æœ**ï¼š
   - `dbfs_matlab.csv` - Matlab è¾“å‡ºçš„ dBFS æ•°æ®
   - `dbfs_tomatis.csv` - Tomatis è¾“å‡ºçš„ dBFS æ•°æ®
   - `dbfs_matlab.png` - Matlab å¯¹æ¯”å›¾
   - `dbfs_tomatis.png` - Tomatis å¯¹æ¯”å›¾

### è„šæœ¬åŠŸèƒ½

- âœ… è‡ªåŠ¨ç»Ÿä¸€é‡‡æ ·ç‡
- âœ… è½¬æ¢ä¸ºå•å£°é“
- âœ… è£å‰ª Tomatis å‰ 16 ç§’
- âœ… äº’ç›¸å…³è‡ªåŠ¨å¯¹é½
- âœ… RMS å½’ä¸€åŒ–ï¼ˆæ¶ˆé™¤æ•´ä½“å¢ç›Šå·®ï¼‰
- âœ… å¸§çº§ dBFS è®¡ç®—ï¼ˆ20ms å¸§ï¼Œ10ms è·³ï¼‰
- âœ… å¯¼å‡º CSV å’Œå¯è§†åŒ–å›¾è¡¨

---

## ğŸ” åˆ†æ gate é˜ˆå€¼çš„æ–¹æ³•

è¿è¡Œè„šæœ¬åï¼Œè§‚å¯Ÿç”Ÿæˆçš„å›¾è¡¨ï¼š

### å¯»æ‰¾çŠ¶æ€åˆ‡æ¢ç‚¹

1. **æŸ¥çœ‹è¾“å‡ºçš„ dBFS æ›²çº¿**ï¼š
   - æ˜¯å¦å­˜åœ¨æ˜æ˜¾çš„"å°é˜¶"æˆ–"æ‹ç‚¹"ï¼Ÿ
   - è¿™äº›åˆ‡æ¢ç‚¹å¯¹åº” gate çš„å¼€/å…³çŠ¶æ€

2. **å¯¹æ¯”è¾“å…¥çš„ dBFS**ï¼š
   - åœ¨åˆ‡æ¢å‘ç”Ÿæ—¶ï¼Œè¾“å…¥çš„ dBFS æ˜¯å¤šå°‘ï¼Ÿ
   - è¿™å°±æ˜¯ gate çš„å€™é€‰ç­‰æ•ˆé˜ˆå€¼

3. **å¤šç‚¹éªŒè¯**ï¼š
   - æ‰¾å‡ºæ‰€æœ‰åˆ‡æ¢ç‚¹
   - ç»Ÿè®¡å¯¹åº”çš„è¾“å…¥ dBFS
   - è®¡ç®—å¹³å‡å€¼å’Œæ ‡å‡†å·®

### ç¤ºä¾‹åˆ†æ

```python
import pandas as pd
import numpy as np

# è¯»å–ç»“æœ
df = pd.read_csv("dbfs_matlab.csv")

# è®¡ç®—è¾“å‡ºçš„å˜åŒ–ç‡ï¼ˆæ£€æµ‹åˆ‡æ¢ç‚¹ï¼‰
df['out_diff'] = df['matlab_dbfs'].diff().abs()

# æ‰¾å‡ºå˜åŒ–ç‡å¤§äºé˜ˆå€¼çš„ç‚¹ï¼ˆå¯èƒ½æ˜¯ gate åˆ‡æ¢ï¼‰
threshold = 3.0  # dB
switch_points = df[df['out_diff'] > threshold]

# æŸ¥çœ‹åˆ‡æ¢æ—¶çš„è¾“å…¥ dBFS
print("Gate åˆ‡æ¢ç‚¹åˆ†æ:")
print(switch_points[['t', 'in_dbfs', 'matlab_dbfs', 'out_diff']])

# ä¼°è®¡ gate é˜ˆå€¼
gate_threshold = switch_points['in_dbfs'].median()
print(f"\nä¼°è®¡çš„ gate é˜ˆå€¼: {gate_threshold:.2f} dBFS")
```

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œåˆ†æè„šæœ¬å‰ï¼Œç¡®ä¿ï¼š

- [ ] conda å·²åœ¨ PowerShell ä¸­åˆå§‹åŒ–ï¼ˆ`conda init powershell`ï¼‰
- [ ] dsp ç¯å¢ƒå·²æ¿€æ´»ï¼ˆ`conda activate dsp`ï¼‰
- [ ] éŸ³é¢‘æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼ˆä¿®æ”¹ `analyze_dbfs.py` ä¸­çš„è·¯å¾„ï¼‰
- [ ] éŸ³é¢‘æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ˆFLAC æˆ– WAVï¼‰
- [ ] æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨ç»“æœ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```powershell
# 1. åˆå§‹åŒ– condaï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
conda init powershell

# 2. é‡å¯ PowerShellï¼Œç„¶åæ¿€æ´»ç¯å¢ƒ
conda activate dsp

# 3. è¿›å…¥é¡¹ç›®ç›®å½•
cd F:\TOMATIS

# 4. è¿è¡Œåˆ†æ
python analyze_dbfs.py

# 5. æŸ¥çœ‹ç»“æœ
ls *.csv, *.png
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- [analyze_dbfs.py](file:///F:/TOMATIS/analyze_dbfs.py) - ä¸»åˆ†æè„šæœ¬
- [test_audio.py](file:///F:/TOMATIS/test_audio.py) - ç®€å•æµ‹è¯•è„šæœ¬ï¼ˆå·²ä¿®å¤ï¼‰
- [é…ç½®å®Œæˆ.md](file:///F:/TOMATIS/é…ç½®å®Œæˆ.md) - ç¯å¢ƒé…ç½®æ€»ç»“
